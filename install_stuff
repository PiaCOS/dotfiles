#!/usr/bin/env bash

# Exit if a command exits with non-zero status
set -e

DOTFILES_DIR="$HOME/Dev/dotfiles"

# ---------------------------------------------------
# 1. PACMAN UPDATE & INSTALLATION
# ---------------------------------------------------

echo "Running system sync and upgrade..."
sudo pacman -Syu --needed archlinux-keyring

echo "Installing core packages..."
sudo pacman -S --needed \
    # Display Server (needed for i3)
    xorg-server \
    # Display Manager (ly)
    ly \
    # Window Manager and friends 
    i3-wm i3blocks i3status i3lock \
    picom dunst feh lxappearance \
    arandr autorandr xorg-xrandr xorg-xinit xorg-xsetroot \
    # Terminal & Utils
    alacritty fish zellij \
    # Dev Tools
    rustup uv helix lazygit ripgrep github-cli fcron \
    # Quality of Life
    fzf rofi xclip fastfetch hyfetch zoxide vim

# ---------------------------------------------------
# 2. POST-INSTALL CONFIGURATION
# ---------------------------------------------------

# Set up Rust toolchain
echo "Installing Rust stable toolchain..."
rustup default stable

# Change default shell to Fish
if grep -q "/usr/bin/fish" /etc/shells; then
    echo "Changing shell to fish..."
    chsh -s /usr/bin/fish
else
    echo "/usr/bin/fish not found in /etc/shells. Skipping chsh."
fi

# Enable the ly Display Manager Service (might need to remove GDM or idk)
echo "Enabling ly Display Manager..."
sudo systemctl enable ly.service

# Symlink setup
if test -f "$DOTFILES_DIR/setup_symlinks.sh"; then
    echo "Executing symlink setup script..."
    /bin/bash "$DOTFILES_DIR/setup_symlinks.sh"
else
    echo "WARNING: Symlink setup script not found at $DOTFILES_DIR/setup_symlinks.sh"
fi

echo "Setup complete. Reboot required to launch ly and fish shell."
